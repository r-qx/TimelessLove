# TimelessLove 小程序开发规范

## 项目概述
TimelessLove 是一款专为情侣打造的任务管理与情感成长小程序，通过游戏化机制促进情侣互动，记录美好瞬间。

## 技术栈

### 前端
- **框架**: 微信小程序原生开发 (WXS + WXML + WXSS)
- **UI库**: WeUI / Vant Weapp
- **状态管理**: MobX 或原生 globalData
- **工具库**: Day.js (日期处理)、Lodash (工具函数)

### 后端
- **框架**: NestJS 10.x
- **数据库**: MongoDB (主要) + Redis (缓存)
- **ORM**: Mongoose
- **认证**: JWT + 微信小程序登录
- **文件存储**: 腾讯云 COS / 阿里云 OSS
- **实时通信**: WebSocket (Socket.io)

## 代码规范

### 通用规范
1. 使用 TypeScript 进行类型安全开发
2. 遵循 ESLint + Prettier 代码格式化
3. 使用 Conventional Commits 规范提交信息
4. 代码注释使用中文，变量命名使用英文

### 命名规范
- **文件名**: kebab-case (例: love-task.service.ts)
- **类名**: PascalCase (例: LoveTaskService)
- **方法/变量**: camelCase (例: getUserTasks)
- **常量**: UPPER_SNAKE_CASE (例: MAX_TASK_COUNT)
- **接口**: I前缀 (例: ITask)
- **类型**: T前缀 (例: TTaskStatus)

### 目录结构

#### 小程序端
```
miniprogram/
├── pages/              # 页面
│   ├── index/          # 首页
│   ├── task/           # 任务相关
│   ├── chat/           # 聊天
│   ├── timeline/       # 时光轴
│   ├── profile/        # 个人中心
│   └── couple/         # CP空间
├── components/         # 组件
│   ├── task-card/      # 任务卡片
│   ├── love-progress/  # 爱心进度
│   └── moment-card/    # 瞬间卡片
├── services/           # 服务层
├── utils/              # 工具函数
├── models/             # 数据模型
├── assets/             # 静态资源
└── store/              # 状态管理
```

#### 后端
```
backend/
├── src/
│   ├── modules/
│   │   ├── auth/       # 认证模块
│   │   ├── user/       # 用户模块
│   │   ├── couple/     # 情侣关系模块
│   │   ├── task/       # 任务模块
│   │   ├── reward/     # 奖励模块
│   │   ├── chat/       # 聊天模块
│   │   ├── moment/     # 瞬间模块
│   │   └── community/  # 社区模块
│   ├── common/         # 公共模块
│   │   ├── decorators/ # 装饰器
│   │   ├── filters/    # 过滤器
│   │   ├── guards/     # 守卫
│   │   ├── pipes/      # 管道
│   │   └── interceptors/ # 拦截器
│   ├── config/         # 配置
│   └── database/       # 数据库
└── test/               # 测试
```

## API 设计规范

### RESTful 规范
- GET: 获取资源
- POST: 创建资源
- PUT: 完整更新资源
- PATCH: 部分更新资源
- DELETE: 删除资源

### 响应格式
```typescript
{
  code: number,        // 状态码
  message: string,     // 消息
  data: any,          // 数据
  timestamp: number   // 时间戳
}
```

### 错误码规范
- 20000: 成功
- 40000: 客户端错误
- 40001: 参数错误
- 40100: 未授权
- 40300: 禁止访问
- 40400: 资源不存在
- 50000: 服务器错误

## 数据库设计规范

### 集合命名
- 使用复数形式
- 小写字母 + 下划线 (例: love_tasks)

### 字段规范
- _id: MongoDB 自动生成
- created_at: 创建时间
- updated_at: 更新时间
- deleted_at: 软删除时间
- is_deleted: 软删除标记

## 性能优化

### 小程序端
1. 使用分包加载
2. 图片懒加载
3. 数据缓存策略
4. 减少 setData 调用
5. 使用虚拟列表处理长列表

### 后端
1. Redis 缓存热点数据
2. 数据库索引优化
3. 分页查询
4. CDN 加速静态资源
5. 接口限流防刷

## 安全规范

1. 敏感信息加密存储
2. 接口签名验证
3. SQL/NoSQL 注入防护
4. XSS 防护
5. 文件上传安全检查
6. 接口权限控制

## Git 工作流

### 分支管理
- main: 生产环境
- develop: 开发环境
- feature/*: 功能分支
- bugfix/*: 修复分支
- hotfix/*: 紧急修复

### Commit 规范
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- perf: 性能优化
- test: 测试
- chore: 构建/工具

## 开发流程

1. 需求分析与设计
2. 数据库设计
3. API 接口设计
4. 后端开发与测试
5. 前端开发与联调
6. 测试与优化
7. 上线部署

## 注意事项

1. 禁止硬编码敏感信息
2. 所有外部调用需要错误处理
3. 定期备份数据库
4. 监控系统性能指标
